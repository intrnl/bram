<!doctype html>
<html lang="en">

<title>lists tests</title>

<link href="https://unpkg.com/mocha@4.1.0/mocha.css" rel="stylesheet">
<script src="https://unpkg.com/chai/chai.js"></script>
<script src="https://unpkg.com/mocha@4.1.0/mocha.js"></script>
<script src="./setup-mocha.js"></script>

<template id="each"><template directive="foreach" expression="names">{{item}}</template></template>

<div id="host"></div>
<div id="mocha"></div>

<script type="module">
  import Bram from '../src/bram.js';

  describe('template[each]', function(){
    const createInstance = model => Bram.createInstance(each, model);

    const first = () => host.firstChild.nextSibling.nextSibling;
    const second = () => first().nextSibling.nextSibling.nextSibling;
    const third = () => second().nextSibling.nextSibling.nextSibling;
    const fourth = () => third().nextSibling.nextSibling.nextSibling;

    afterEach(function(){
      host.innerHTML = '';
    });

    describe('Existing arrays works', function(){
      let data;

      beforeEach(function(){
        let instance = createInstance({
          names: ['Matthew', 'Anne', 'Wilbur']
        });
        data = instance.model;
        host.appendChild(instance.fragment);
      });

      it('All items added', function(){
        assert.equal(first().data, 'Matthew');
        assert.equal(second().data, 'Anne');
        assert.equal(third().data, 'Wilbur');
      });

      it('Can unshift an item to the front', function(){
        data.names.unshift('French');

        assert.equal(first().data, 'French');
        assert.equal(second().data, 'Matthew');
        assert.equal(third().data, 'Anne');
        assert.equal(fourth().data, 'Wilbur');
      });

      it('Can push an item on the end', function(){
        data.names.push('French');

        assert.equal(first().data, 'Matthew');
        assert.equal(second().data, 'Anne');
        assert.equal(third().data, 'Wilbur');
        assert.equal(fourth().data, 'French');
      });

      it('Can change the reference', function(){
        data.names[0] = 'French';

        assert.equal(first().data, 'French');
        assert.equal(second().data, 'Anne');
        assert.equal(third().data, 'Wilbur');
      });

      it('Can splice out items', function(){
        data.names.splice(0, 1);
        assert.equal(first().data, 'Anne');
        assert.equal(second().data, 'Wilbur');

        data.names.splice(0, 1);
        assert.equal(first().data, 'Wilbur');

        data.names.splice(0, 1);

        {
          let first = host.firstChild.nextSibling;
          assert.equal(first, undefined);
        }
      });

      it('can replace items with splice', function(){
        data.names.splice(0, 0, 'French');

        assert.equal(first().data, 'French');
        assert.equal(second().data, 'Matthew');
      });
    });

    describe('replacing a list', function(){
      var data;

      beforeEach(function(){
        let instance = createInstance({
          names: ['Matthew', 'Anne', 'Wilbur']
        });
        data = instance.model;
        host.append(instance.fragment);
      });

      it('updates itself', function(){
        data.names = ['Foo', 'Bar'];
        assert.equal(first().nodeValue, 'Foo');
        assert.equal(second().nodeValue, 'Bar');

        data.names.push('Baz');
        assert.equal(third().nodeValue, 'Baz');
      });
    });
  });
</script>